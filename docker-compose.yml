# ===========================================
# AgentCheck Docker Compose Configuration
# ===========================================
#
# Usage:
#   Start all:    docker-compose up -d
#   Build only:   docker-compose build
#   View logs:    docker-compose logs -f
#   Stop:         docker-compose down
#
# ===========================================

services:
  # ===========================================
  # Main Service - Backend API + React Frontend
  # ===========================================
  agentcheck:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: agentcheck
    ports:
      - "${FRONTEND_PORT:-3000}:3000" # Nginx serves both frontend and proxies API
    environment:
      - PORT=3000 # For local: nginx listens on 3000 (start.sh uses this)
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-groq}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATA_DIR=/app/data
      - CONFIG_DIR=/app/config
    volumes:
      # Persist data directory
      - agentcheck-data:/app/data
      # Mount config for easy updates
      - ./config:/app/config:ro
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - agentcheck-network

  # ===========================================
  # Development Service (optional)
  # ===========================================
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: agentcheck-dev
    ports:
      - "8000:8000"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-groq}
      - LOG_LEVEL=DEBUG
      - DATA_DIR=/app/data
      - CONFIG_DIR=/app/config
    volumes:
      # Mount source code for hot reload
      - ./api:/app/api
      - ./config:/app/config
      - ./tests:/app/tests
      - agentcheck-data:/app/data
    profiles:
      - dev
    networks:
      - agentcheck-network

# ===========================================
# Volumes
# ===========================================
volumes:
  agentcheck-data:
    driver: local

# ===========================================
# Networks
# ===========================================
networks:
  agentcheck-network:
    driver: bridge
